// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// User model - for store owners and staff
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  emailVerified Boolean   @default(false)
  role          UserRole  @default(STORE_OWNER)
  isActive      Boolean   @default(true)
  
  // Relations
  stores        Store[]   @relation("StoreOwner")
  staffStores   StoreStaff[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("users")
}

enum UserRole {
  SUPER_ADMIN
  STORE_OWNER
  STORE_STAFF
}

// Store model - represents individual merchant stores
model Store {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  slug          String    @unique
  description   String?
  logo          String?
  banner        String?
  
  // Store settings
  currency      String    @default("USD")
  language      String    @default("en")
  timezone      String    @default("UTC")
  
  // Contact information
  email         String
  phone         String?
  address       String?
  city          String?
  state         String?
  country       String?
  postalCode    String?
  
  // Business information
  businessName  String?
  taxNumber     String?
  
  // Store status
  status        StoreStatus @default(PENDING)
  isActive      Boolean   @default(false)
  isPremium     Boolean   @default(false)
  
  // Theme and customization
  theme         String    @default("default")
  customDomain  String?
  
  // SEO
  metaTitle     String?
  metaDescription String?
  metaKeywords  String[]
  
  // Social media
  facebook      String?
  instagram     String?
  twitter       String?
  linkedin      String?
  
  // Relations
  ownerId       String    @db.ObjectId
  owner         User      @relation("StoreOwner", fields: [ownerId], references: [id])
  staff         StoreStaff[]
  products      Product[]
  categories    Category[]
  customers     Customer[]
  orders        Order[]
  payments      Payment[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([ownerId])
  @@map("stores")
}

enum StoreStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CLOSED
}

// Staff management for stores
model StoreStaff {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  userId        String    @db.ObjectId
  user          User      @relation(fields: [userId], references: [id])
  
  permissions   String[]  // Array of permission strings
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, userId])
  @@map("store_staff")
}

// Product category
model Category {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name          String
  slug          String
  description   String?
  image         Json?     // { path: string (required), public_id: string (required) }
  
  parentId      String?   @db.ObjectId
  parent        Category? @relation("SubCategories", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      Category[] @relation("SubCategories")
  
  isActive      Boolean   @default(true)
  sortOrder     Int       @default(0)
  
  products      Product[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, slug])
  @@index([storeId])
  @@map("categories")
}

// Product model
model Product {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name          String
  slug          String
  description   String?
  shortDescription String?
  
  // Pricing
  price         Float
  comparePrice  Float?    // Original price for showing discounts
  costPrice     Float?    // Cost to merchant
  
  // Inventory
  sku           String?
  barcode       String?
  trackQuantity Boolean   @default(true)
  quantity      Int       @default(0)
  lowStockAlert Int       @default(10)
  
  // Product details
  weight        Float?
  weightUnit    String    @default("kg")
  
  // Media
  mainImage     Json      // { path: string (required), public_id: string (required) }
  subImages     Json[]    // Array of { path: string (required), public_id: string (required) }
  thumbnail     String?
  
  // SEO
  metaTitle     String?
  metaDescription String?
  metaKeywords  String[]
  
  // Status
  status        ProductStatus @default(DRAFT)
  isActive      Boolean   @default(true)
  isFeatured    Boolean   @default(false)
  
  // Relations
  categoryId    String?   @db.ObjectId
  category      Category? @relation(fields: [categoryId], references: [id])
  variants      ProductVariant[]
  orderItems    OrderItem[]
  reviews       Review[]
  
  // Analytics
  viewCount     Int       @default(0)
  soldCount     Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, slug])
  @@index([storeId])
  @@index([categoryId])
  @@map("products")
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Product variants (size, color, etc.)
model ProductVariant {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  productId     String    @db.ObjectId
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name          String    // e.g., "Large Red"
  sku           String?
  price         Float?    // If different from base product
  quantity      Int       @default(0)
  
  // Variant attributes
  attributes    Json      // { size: "L", color: "Red" }
  
  image         String?
  isActive      Boolean   @default(true)
  
  orderItems    OrderItem[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("product_variants")
}

// Customer model
model Customer {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  email         String
  password      String?   // Optional for guest checkouts
  firstName     String
  lastName      String
  phone         String?
  
  emailVerified Boolean   @default(false)
  isActive      Boolean   @default(true)
  isGuest       Boolean   @default(false)
  
  // Default addresses
  addresses     Address[]
  
  // Relations
  orders        Order[]
  reviews       Review[]
  
  // Analytics
  totalSpent    Float     @default(0)
  orderCount    Int       @default(0)
  
  lastOrderAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([storeId, email])
  @@index([storeId])
  @@map("customers")
}

// Address model
model Address {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  customerId    String?   @db.ObjectId
  customer      Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  type          AddressType @default(SHIPPING)
  isDefault     Boolean   @default(false)
  
  fullName      String
  company       String?
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  country       String
  postalCode    String
  phone         String?
  
  orders        Order[]   @relation("ShippingAddress")
  billingOrders Order[]   @relation("BillingAddress")
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("addresses")
}

enum AddressType {
  BILLING
  SHIPPING
  BOTH
}

// Order model
model Order {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  orderNumber   String    @unique
  
  customerId    String?   @db.ObjectId
  customer      Customer? @relation(fields: [customerId], references: [id])
  
  // Guest customer info (if not registered)
  guestEmail    String?
  guestName     String?
  guestPhone    String?
  
  // Addresses
  shippingAddressId String? @db.ObjectId
  shippingAddress Address? @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  billingAddressId String? @db.ObjectId
  billingAddress Address? @relation("BillingAddress", fields: [billingAddressId], references: [id])
  
  // Order details
  items         OrderItem[]
  
  // Pricing
  subtotal      Float
  taxAmount     Float     @default(0)
  shippingCost  Float     @default(0)
  discount      Float     @default(0)
  total         Float
  
  // Payment
  paymentMethod String?
  paymentStatus PaymentStatus @default(PENDING)
  paidAt        DateTime?
  
  // Fulfillment
  status        OrderStatus @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  
  // Shipping
  shippingMethod String?
  trackingNumber String?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  // Notes
  customerNote  String?
  staffNote     String?
  
  // Relations
  payments      Payment[]
  
  cancelledAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([storeId])
  @@index([customerId])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  PARTIALLY_FULFILLED
  FULFILLED
}

// Order items
model OrderItem {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String    @db.ObjectId
  order         Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     String    @db.ObjectId
  product       Product   @relation(fields: [productId], references: [id])
  
  variantId     String?   @db.ObjectId
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  
  // Snapshot of product info at time of order
  productName   String
  productSku    String?
  variantName   String?
  
  price         Float
  quantity      Int
  total         Float
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("order_items")
}

// Payment transactions
model Payment {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  storeId       String    @db.ObjectId
  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  orderId       String    @db.ObjectId
  order         Order     @relation(fields: [orderId], references: [id])
  
  amount        Float
  currency      String
  
  method        String    // credit_card, paypal, bank_transfer, etc.
  status        PaymentTransactionStatus @default(PENDING)
  
  // Payment gateway info
  transactionId String?   // From payment provider
  gatewayResponse Json?   // Raw response from gateway
  
  paidAt        DateTime?
  failedAt      DateTime?
  refundedAt    DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([storeId])
  @@index([orderId])
  @@map("payments")
}

enum PaymentTransactionStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

// Product reviews
model Review {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  productId     String    @db.ObjectId
  product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  customerId    String    @db.ObjectId
  customer      Customer  @relation(fields: [customerId], references: [id])
  
  rating        Int       // 1-5
  title         String?
  comment       String?
  
  isVerified    Boolean   @default(false) // Verified purchase
  isApproved    Boolean   @default(false) // Approved by store owner
  
  helpfulCount  Int       @default(0)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([productId])
  @@map("reviews")
}